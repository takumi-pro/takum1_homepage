---
title: "ApplicationJobをSidekiq-cronで実行する時はactive_jobを明示しないとダメだよ"
pubDate: "2025-08-24"
description: ""
author: "Takumi"
image:
  url: "/blog-placeholder-1.jpg"
  alt: "ブログのプレースホルダー画像"
categories: ["Rails", "Sidekiq", "ActiveJob"]
---


Doorkeeperを用いてtokenの発行や保存を行なっていると、徐々に期限切れtokenやrevokeされたtokenがデータベースに蓄積されていく。そのため、Doorkeeperではそれらのtokenデータを削除するRakeタスクが用意されている。

https://doorkeeper.gitbook.io/guides/internals/rake

このRakeタスクは定期スケジュールされており、毎日3時に実行されることとなっているが、実行されていないことに先日気づいた。

↓schedule.yaml
```yaml
clean_up_job:
  cron: "0 3 * * * Asia/Tokyo"
  class: "CleanUpJob"
```

本番のlogからは `undefined method perform_async`と出力されており、perform_asyncが定義されていないようだった。
`CleanUpJob`を確認してみると`ApplicationJob`が継承されていたため、CleanUpJobがSidekiq JobではなくActiveJobとみなされていたことが原因だった。

```rb
class CleanUpJob < ApplicationJob
  extend T::Sig

  sig { void }
  def perform
    system("bundle exec rake doorkeeper:db:cleanup", exception: true)
  end
end
```

Sidekiq Jobとして実行するにはschedule.yamlに`active_job: true`を明示する必要があったため、以下のように修正すると正常に実行されるようになった。

```yaml
clean_up_job:
  cron: "0 3 * * * Asia/Tokyo"
  class: "CleanUpJob"
  active_job: true
```

